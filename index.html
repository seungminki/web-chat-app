<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>Ï±ÑÌåÖ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
        }
        .nickname-container {
            width: 100%;
            max-width: 400px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 40px 30px;
            text-align: center;
            margin: 20px;
        }
        .nickname-container h2 {
            margin-bottom: 30px;
            color: #000;
            font-size: 20px;
            font-weight: 600;
        }
        .nickname-container input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        .nickname-container input:focus {
            outline: none;
            border-color: #a8d4f5;
        }
        .nickname-container button {
            width: 100%;
            padding: 14px 24px;
            background: #a8d4f5;
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            transition: background 0.2s;
        }
        .nickname-container button:hover {
            background: #91c7f0;
        }
        .chat-container {
            width: 100%;
            max-width: 100vw;
            height: 100vh;
            background: #ffffff;
            display: none;
            flex-direction: column;
        }
        .chat-container.active {
            display: flex;
        }
        .chat-header {
            background: #fff;
            padding: 12px 16px;
            border-bottom: 1px solid #d1d1d1;
            font-weight: 600;
            font-size: 18px;
            color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 56px;
        }
        .chat-header-title {
            flex: 1;
        }
        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .notification-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s;
        }
        .notification-btn:hover {
            background: #f5f5f5;
        }
        .notification-btn.active {
            color: #a8d4f5;
        }
        .search-btn {
            font-size: 18px;
        }
        .search-toolbar {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-bottom: 1px solid #e4e4e4;
            background: #fafafa;
        }
        .search-toolbar.show {
            display: flex;
        }
        .search-input {
            flex: 1;
            min-width: 0;
            height: 34px;
            border: 1px solid #d5d5d5;
            border-radius: 10px;
            padding: 0 12px;
            font-size: 14px;
            outline: none;
            background: #fff;
        }
        .search-input:focus {
            border-color: #87b3d9;
        }
        .search-nav-btn {
            width: 34px;
            height: 34px;
            border: 1px solid #d5d5d5;
            border-radius: 10px;
            background: #fff;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        .search-nav-btn:hover {
            background: #f4f4f4;
        }
        .search-nav-btn:disabled {
            opacity: 0.45;
            cursor: default;
            background: #fff;
        }
        .search-run-btn {
            height: 34px;
            border: 1px solid #d5d5d5;
            border-radius: 10px;
            background: #fff;
            padding: 0 12px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        .search-run-btn:hover {
            background: #f4f4f4;
        }
        .search-count {
            min-width: 56px;
            text-align: center;
            font-size: 12px;
            color: #666;
            user-select: none;
        }
        .search-close-btn {
            width: 34px;
            height: 34px;
            border: none;
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }
        .search-close-btn:hover {
            background: #ececec;
        }
        .messages-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow-anchor: none;
        }
        .new-message-banner {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a73e8;
            color: #fff;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            display: none;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0,0,0,0.25);
            z-index: 100;
            white-space: nowrap;
            align-items: center;
            gap: 6px;
            user-select: none;
            border: none;
            animation: bannerSlideUp 0.2s ease-out;
        }
        .new-message-banner.show {
            display: flex;
        }
        @keyframes bannerSlideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(6px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .drop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(168, 212, 245, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            color: #000;
            z-index: 10;
            pointer-events: none;
        }
        .drop-overlay.show {
            display: flex;
        }
        .message {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            align-items: flex-end;
        }
        .message.me {
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        .message.me .message-avatar {
            display: none;
        }
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .message-content {
            display: flex;
            flex-direction: column;
            max-width: 65%;
            gap: 4px;
        }
        .message.me .message-content {
            align-items: flex-end;
        }
        .message-nickname {
            font-size: 12px;
            font-weight: 500;
            color: #000;
            padding: 0 4px;
            margin-bottom: 2px;
        }
        .message.me .message-nickname {
            display: none;
        }
        .message-row {
            display: flex;
            align-items: flex-end;
            gap: 4px;
        }
        .message.me .message-row {
            flex-direction: row-reverse;
        }
        .message-bubble {
            padding: 8px 12px;
            border-radius: 4px;
            word-wrap: break-word;
            background: #F1F3F4;
            color: #000;
            font-size: 14px;
            line-height: 20px;
            max-width: 100%;
            white-space: pre-wrap;
        }
        .message.me .message-bubble {
            background: #D2E3FC;
            color: #000;
        }
        .message.search-selected .message-bubble {
            box-shadow: 0 0 0 2px #1a73e8 inset;
        }
        .message-bubble img {
            max-width: 250px;
            max-height: 250px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
        }
        .image-loading {
            width: 250px;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 8px;
            gap: 12px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #a8d4f5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 13px;
            color: #666;
        }
        .message-time {
            font-size: 11px;
            color: rgba(0, 0, 0, 0.4);
            white-space: nowrap;
            align-self: flex-end;
            padding: 0 2px;
        }
        .date-divider {
            align-self: center;
            margin: 14px 0 8px;
            padding: 5px 12px;
            border-radius: 999px;
            background: #f1f3f4;
            border: 1px solid #d1d1d1;
            color: #666;
            font-size: 12px;
            font-weight: 500;
            user-select: none;
        }
        .message.new {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chat-input-container {
            padding: 8px 12px;
            background: #fff;
            border-top: 1px solid #d1d1d1;
        }
        .chat-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid #d1d1d1;
            border-radius: 20px;
            background: #F1F3F4;
            transition: border-color 0.2s;
        }
        .chat-input:focus-within {
            border-color: #999;
            background: #F1F3F4;
        }
        .chat-input textarea {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
            color: #000;
            background: transparent;
            resize: none;
            max-height: 120px;
            min-height: 20px;
            font-family: inherit;
            line-height: 20px;
            overflow-y: auto;
        }
        .input-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .plus-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            color: #666;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 24px;
            font-weight: 300;
            position: relative;
        }
        .plus-btn:hover {
            background: rgba(0,0,0,0.05);
        }
        .plus-menu {
            position: absolute;
            bottom: 45px;
            left: 0;
            background: white;
            border: 1px solid #d1d1d1;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
            min-width: 140px;
            z-index: 100;
        }
        .plus-menu.show {
            display: block;
        }
        .plus-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #000;
            transition: background 0.2s;
        }
        .plus-menu-item:hover {
            background: #f5f5f5;
        }
        .plus-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        .plus-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        .send-btn {
            width: 32px;
            height: 32px;
            background: #a8d4f5;
            color: #000;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 16px;
            font-weight: bold;
        }
        .send-btn:hover {
            background: #91c7f0;
        }
        .send-btn:disabled {
            background: #d1d1d1;
            cursor: not-allowed;
        }
        .error {
            color: #e03131;
            font-size: 13px;
            margin-top: 12px;
        }
        /* ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú */
        .avatar-upload {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #e0e0e0;
            margin: 0 auto 24px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 2px solid #d0d0d0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .avatar-default-icon {
            font-size: 36px;
            color: #bbb;
            user-select: none;
        }
        .avatar-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }
        .avatar-upload-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            gap: 2px;
        }
        .avatar-upload:hover .avatar-upload-overlay {
            opacity: 1;
        }
        .avatar-upload-overlay .overlay-icon {
            font-size: 20px;
            color: white;
        }
        .avatar-upload-overlay .overlay-text {
            font-size: 10px;
            color: white;
            font-weight: 500;
        }
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: toastSlideIn 0.3s ease-out;
            font-size: 14px;
        }
        .notification-toast.show {
            display: flex;
        }
        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        .image-modal.show {
            display: flex;
        }
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        #fileInput {
            display: none;
        }

        /* URL ÎØ∏Î¶¨Î≥¥Í∏∞ Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .link-preview {
            margin-top: 8px;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            border: 1px solid #ddd;
            width: 100%;
            max-width: 250px;
            cursor: pointer;
            text-decoration: none;
            display: block;
        }
        .link-preview img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .link-preview-info {
            padding: 8px;
        }
        .link-preview-title {
            font-size: 13px;
            font-weight: bold;
            color: #000;
            margin-bottom: 4px;
            display: -webkit-box;

            line-clamp: 1;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .link-preview-desc {
            font-size: 11px;
            color: #666;
            display: -webkit-box;

            line-clamp: 1;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="nickname-container" id="nicknameContainer">
        <h2>üí¨ Ï±ÑÌåÖÎ∞© ÏûÖÏû•</h2>
        <div class="avatar-upload" id="avatarUpload" onclick="document.getElementById('profilePhotoInput').click()" title="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏÑ†ÌÉù (ÏÑ†ÌÉùÏÇ¨Ìï≠)">
            <span class="avatar-default-icon" id="avatarDefaultIcon">üë§</span>
            <img class="avatar-preview-img" id="avatarPreviewImg" src="" alt="">
            <div class="avatar-upload-overlay">
                <span class="overlay-icon">üì∑</span>
                <span class="overlay-text" id="avatarOverlayText">ÏÇ¨ÏßÑ Ï∂îÍ∞Ä</span>
            </div>
        </div>
        <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" onchange="handleProfilePhotoSelect(event)">
        <input type="text" id="nicknameInput" placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="10" onkeypress="if(event.key==='Enter') enterChat()">
        <button onclick="enterChat()">ÏûÖÏû•ÌïòÍ∏∞</button>
        <div class="error" id="nicknameError"></div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-header-title" id="chatHeader">Ï±ÑÌåÖ</div>
            <div class="chat-header-actions">
                <button class="notification-btn search-btn" id="searchBtn" onclick="toggleSearchBar()" title="Î©îÏãúÏßÄ Ï∞æÍ∏∞">üîé</button>
                <button class="notification-btn" id="notificationBtn" onclick="toggleNotification()" title="ÏïåÎ¶º ÏÑ§Ï†ï">üîî</button>
            </div>
        </div>
        <div class="search-toolbar" id="searchToolbar">
            <input type="text" id="searchInput" class="search-input" placeholder="Î©îÏãúÏßÄ ÎÇ¥Ïö© Í≤ÄÏÉâ" oninput="onSearchInputChanged()" onkeydown="handleSearchKeyDown(event)">
            <button class="search-run-btn" onclick="executeSearch()" title="Í≤ÄÏÉâ Ïã§Ìñâ">Í≤ÄÏÉâ</button>
            <span class="search-count" id="searchCount">0/0</span>
            <button class="search-nav-btn" id="searchPrevBtn" onclick="moveSearchResult(-1)" title="Ïù¥Ï†Ñ Í≤∞Í≥º" disabled>‚Üë</button>
            <button class="search-nav-btn" id="searchNextBtn" onclick="moveSearchResult(1)" title="Îã§Ïùå Í≤∞Í≥º" disabled>‚Üì</button>
            <button class="search-close-btn" onclick="closeSearchBar()" title="Îã´Í∏∞">‚úï</button>
        </div>
        <div class="messages-wrapper">
            <div class="chat-messages" id="messages">
                <div class="drop-overlay" id="dropOverlay">üì∑ ÏÇ¨ÏßÑÏùÑ Ïó¨Í∏∞Ïóê ÎÜìÏúºÏÑ∏Ïöî</div>
            </div>
            <button class="new-message-banner" id="newMessageBanner" onclick="scrollToBottom()"></button>
        </div>
        <div class="chat-input-container">
            <div class="chat-input">
                <div style="position: relative;">
                    <button class="plus-btn" id="plusBtn" onclick="togglePlusMenu()">+</button>
                    <div class="plus-menu" id="plusMenu">
                        <div class="plus-menu-item" onclick="openImagePicker()">
                            üì∑ ÏÇ¨ÏßÑ Ï∂îÍ∞Ä
                        </div>
                    </div>
                </div>
                <textarea id="messageInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
                <div class="input-buttons">
                    <button class="send-btn" onclick="sendMessage()">‚Üë</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" onchange="handleImageSelect(event)">

    <div class="notification-toast" id="notificationToast">
        <span id="toastMessage"></span>
    </div>

    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="">
    </div>

    <script src="/local-config.js" onerror="void 0"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <script>
        let myNickname = '';
        let myPhotoURL = '';
        let selectedProfilePhotoFile = null;
        let unreadCount = 0;
        let database;
        let storage;
        let messagesRef;
        let notificationEnabled = false;
        let isFirstLoad = true;
        let lastRenderedDateKey = null;
        const DAY_MS = 24 * 60 * 60 * 1000;
        let historyWindowStart = null;
        let isLoadingHistory = false;
        let hasMoreHistory = true;
        let canLoadOlderOnScroll = false;
        const loadedMessageIds = new Set();
        let searchMatches = [];
        let currentSearchMatchIndex = -1;
        let toastTimer = null;

        // ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏÑ†ÌÉù Ï≤òÎ¶¨
        function handleProfilePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;

            selectedProfilePhotoFile = file;
            event.target.value = '';

            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImg = document.getElementById('avatarPreviewImg');
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                document.getElementById('avatarDefaultIcon').style.display = 'none';
                document.getElementById('avatarOverlayText').textContent = 'Î≥ÄÍ≤Ω';
            };
            reader.readAsDataURL(file);
        }

        // Ïä§ÌÅ¨Î°§Ïù¥ ÌïòÎã® Í∑ºÏ≤òÏù∏ÏßÄ ÌôïÏù∏ (80px Ïó¨Ïú†)
        function isNearBottom() {
            const c = document.getElementById('messages');
            return c.scrollHeight - c.scrollTop - c.clientHeight < 80;
        }

        // ÏÉà Î©îÏãúÏßÄ Î∞∞ÎÑà ÌëúÏãú
        function showNewMessageBanner() {
            unreadCount++;
            const banner = document.getElementById('newMessageBanner');
            banner.textContent = unreadCount > 1
                ? `‚Üì ÏÉà Î©îÏãúÏßÄ (${unreadCount})`
                : '‚Üì ÏÉà Î©îÏãúÏßÄ';
            banner.classList.add('show');
        }

        // ÏÉà Î©îÏãúÏßÄ Î∞∞ÎÑà Ïà®ÍπÄ
        function hideNewMessageBanner() {
            unreadCount = 0;
            document.getElementById('newMessageBanner').classList.remove('show');
        }

        // ÌïòÎã®ÏúºÎ°ú Ïä§ÌÅ¨Î°§ (Î∞∞ÎÑà ÌÅ¥Î¶≠ Ïãú)
        function scrollToBottom() {
            const c = document.getElementById('messages');
            c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' });
            hideNewMessageBanner();
        }

        // textarea ÏûêÎèô ÎÜíÏù¥ Ï°∞Ï†à
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Enter ÌÇ§ Ï≤òÎ¶¨ (Shift+EnterÎäî Ï§ÑÎ∞îÍøà, EnterÎäî Ï†ÑÏÜ°)
        function handleKeyDown(event) {
            // ÌïúÍ∏Ä Ï°∞Ìï© Ï§ëÏóêÎäî Î¨¥Ïãú (Mac ÌïúÍ∏Ä ÏûÖÎ†• Î≤ÑÍ∑∏ Î∞©ÏßÄ)
            if (event.isComposing || event.keyCode === 229) {
                return;
            }
            
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // + Î©îÎâ¥ ÌÜ†Í∏Ä
        function togglePlusMenu() {
            const menu = document.getElementById('plusMenu');
            menu.classList.toggle('show');
        }

        // Î©îÎâ¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
        document.addEventListener('click', function(event) {
            const plusBtn = document.getElementById('plusBtn');
            const plusMenu = document.getElementById('plusMenu');
            if (plusBtn && plusMenu && !plusBtn.contains(event.target) && !plusMenu.contains(event.target)) {
                plusMenu.classList.remove('show');
            }
        });

        // Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉùÏ∞Ω Ïó¥Í∏∞
        function openImagePicker() {
            document.getElementById('fileInput').click();
            document.getElementById('plusMenu').classList.remove('show');
        }

        // Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ï≤òÎ¶¨ (ÌååÏùº ÏÑ†ÌÉù/Î∂ôÏó¨ÎÑ£Í∏∞/ÎìúÎûòÍ∑∏Ïï§ÎìúÎûç Í≥µÌÜµ)
        async function uploadImage(file) {
            if (!file) return;

            // ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Ïù¥ÎØ∏ÏßÄÎäî 5MB Ïù¥ÌïòÎßå Ï†ÑÏÜ° Í∞ÄÎä•Ìï©ÎãàÎã§');
                return;
            }

            // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏
            if (!file.type.startsWith('image/')) {
                showToast('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå Ï†ÑÏÜ° Í∞ÄÎä•Ìï©ÎãàÎã§');
                return;
            }

            try {
                const timestamp = Date.now();
                
                // Î°úÎî© Î©îÏãúÏßÄ Î®ºÏ†Ä ÌëúÏãú
                const loadingMessageRef = await messagesRef.push({
                    nickname: myNickname,
                    timestamp: timestamp,
                    type: 'image-loading',
                    photoURL: myPhotoURL || null
                });
                
                // Firebase StorageÏóê ÏóÖÎ°úÎìú
                const filename = `${timestamp}_${file.name}`;
                const storageRef = storage.ref(`profiles/${filename}`);
                
                const snapshot = await storageRef.put(file);
                const imageUrl = await snapshot.ref.getDownloadURL();

                // Î°úÎî© Î©îÏãúÏßÄÎ•º Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                await loadingMessageRef.update({
                    imageUrl: imageUrl,
                    type: 'image'
                });
            } catch (error) {
                console.error('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
                showToast('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®: ' + error.message);
            }
        }

        // Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù Ï≤òÎ¶¨
        async function handleImageSelect(event) {
            const file = event.target.files[0];
            await uploadImage(file);
            event.target.value = '';
        }

        // Î∂ôÏó¨ÎÑ£Í∏∞ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        document.addEventListener('paste', async function(event) {
            if (!messagesRef) return;
            
            const items = event.clipboardData?.items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault();
                    const file = items[i].getAsFile();
                    await uploadImage(file);
                    break;
                }
            }
        });

        // ÎìúÎûòÍ∑∏Ïï§ÎìúÎûç Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        let dragCounter = 0;
        const messagesContainer = document.getElementById('messages');
        const dropOverlay = document.getElementById('dropOverlay');

        document.addEventListener('dragenter', function(event) {
            if (!messagesRef) return;
            dragCounter++;
            if (event.dataTransfer.types.includes('Files')) {
                dropOverlay.classList.add('show');
            }
        });

        document.addEventListener('dragleave', function(event) {
            if (!messagesRef) return;
            dragCounter--;
            if (dragCounter === 0) {
                dropOverlay.classList.remove('show');
            }
        });

        document.addEventListener('dragover', function(event) {
            if (!messagesRef) return;
            if (event.dataTransfer.types.includes('Files')) {
                event.preventDefault();
            }
        });

        document.addEventListener('drop', async function(event) {
            if (!messagesRef) return;
            event.preventDefault();
            dragCounter = 0;
            dropOverlay.classList.remove('show');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                await uploadImage(files[0]);
            }
        });

        // Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ Ïó¥Í∏∞
        function openImageModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('show');
            modalImg.src = imageUrl;
        }

        // Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ Îã´Í∏∞
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
        }

        // Î∏åÎùºÏö∞Ï†Ä ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }

            return false;
        }

        // ÏïåÎ¶º ÌÜ†Í∏Ä
        async function toggleNotification() {
            const btn = document.getElementById('notificationBtn');
            
            if (!notificationEnabled) {
                const granted = await requestNotificationPermission();
                if (granted) {
                    notificationEnabled = true;
                    btn.classList.add('active');
                    showToast('ÏïåÎ¶ºÏù¥ ÏºúÏ°åÏäµÎãàÎã§');
                    localStorage.setItem('chatNotificationEnabled', 'true');
                } else {
                    showToast('ÏïåÎ¶º Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§');
                }
            } else {
                notificationEnabled = false;
                btn.classList.remove('active');
                showToast('ÏïåÎ¶ºÏù¥ Í∫ºÏ°åÏäµÎãàÎã§');
                localStorage.setItem('chatNotificationEnabled', 'false');
            }
        }

        // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('show');

            if (toastTimer) {
                clearTimeout(toastTimer);
            }

            toastTimer = setTimeout(() => {
                toast.classList.remove('show');
                toastTimer = null;
            }, duration);
        }

        // Î∏åÎùºÏö∞Ï†Ä ÏïåÎ¶º ÌëúÏãú
        function showBrowserNotification(nickname, text) {
            if (!notificationEnabled || !('Notification' in window)) return;
            if (Notification.permission !== 'granted') return;
            
            if (document.hasFocus()) return;

            const notification = new Notification(`üí¨ ${nickname}ÎãòÏùò Î©îÏãúÏßÄ`, {
                body: text || 'ÏÇ¨ÏßÑÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§',
                tag: 'chat-message',
                requireInteraction: false
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };

            setTimeout(() => notification.close(), 3000);
        }

        async function enterChat() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            
            // 1. ÎãâÎÑ§ÏûÑ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (nickname === '') {
                document.getElementById('nicknameError').textContent = 'ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
                return;
            }
            if (nickname.length < 2) {
                document.getElementById('nicknameError').textContent = 'ÎãâÎÑ§ÏûÑÏùÄ 2Í∏ÄÏûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
                return;
            }

            myNickname = nickname;

            try {
                if (typeof firebase === 'undefined') {
                    document.getElementById('nicknameError').textContent = 'Firebase Î°úÎî© Ï§ë... Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                    return;
                }

                document.getElementById('nicknameError').textContent = 'Firebase Ïó∞Í≤∞ Ï§ë...';
                
                // 2. Firebase Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Î∞©ÏßÄ
                if (firebase.apps.length === 0) {
                    const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                    const localPort = (window.LOCAL_CONFIG && window.LOCAL_CONFIG.port);
                    const configUrl = isLocal ? `http://localhost:${localPort}` : '/.netlify/functions/firebase-config';
                    const response = await fetch(configUrl);
                    if (!response.ok) {
                        throw new Error('Firebase ÏÑ§Ï†ïÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                    }
                    const firebaseConfig = await response.json();
                    firebase.initializeApp(firebaseConfig);
                }

                database = firebase.database();
                storage = firebase.storage();
                messagesRef = database.ref('messages');
                canLoadOlderOnScroll = false;

                // ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú (ÏÑ†ÌÉùÌïú Í≤ΩÏö∞)
                if (selectedProfilePhotoFile) {
                    document.getElementById('nicknameError').textContent = 'ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ï§ë...';
                    try {
                        const ext = selectedProfilePhotoFile.name.split('.').pop() || 'jpg';
                        const profileRef = storage.ref(`profiles/profile_${Date.now()}.${ext}`);
                        const snapshot = await profileRef.put(selectedProfilePhotoFile);
                        myPhotoURL = await snapshot.ref.getDownloadURL();
                    } catch (e) {
                        console.error('ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ïã§Ìå®:', e);
                        showToast('ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ïã§Ìå®. ÏÇ¨ÏßÑ ÏóÜÏù¥ ÏûÖÏû•Ìï©ÎãàÎã§.');
                    }
                }

                // UIÎ•º Î®ºÏ†Ä ÌëúÏãúÌï¥ Ï¥àÍ∏∞ Î©îÏãúÏßÄ Î†åÎçî Ïãú Ïã§Ï†ú Ïä§ÌÅ¨Î°§ ÎÜíÏù¥Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏûàÍ≤å ÌïúÎã§.
                document.getElementById('nicknameContainer').style.display = 'none';
                document.getElementById('chatContainer').classList.add('active');
                document.getElementById('chatHeader').textContent = myNickname;
                document.getElementById('messageInput').focus();

                const oneDayAgo = Date.now() - DAY_MS;
                const recentQuery = messagesRef.orderByChild('timestamp').startAt(oneDayAgo);
                lastRenderedDateKey = null;
                historyWindowStart = oneDayAgo;
                isLoadingHistory = false;
                hasMoreHistory = true;
                loadedMessageIds.clear();

                // 3. Î©îÏãúÏßÄ Ï∂îÍ∞Ä Î¶¨Ïä§ÎÑà (ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÏßÅ ÌÜµÌï©)
                recentQuery.on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    const messageKey = snapshot.key;
                    if (loadedMessageIds.has(messageKey)) return;
                    loadedMessageIds.add(messageKey);
                    
                    // UIÏóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä (Ïù¥ Ìï®ÏàòÍ∞Ä ÏöîÏÜåÎ•º ÏÉùÏÑ±Ìï®)
                    addMessageToUI(message, messageKey);
                    
                    // Ï∂îÍ∞ÄÎêú Î©îÏãúÏßÄ ÏöîÏÜå Ï∞æÍ∏∞
                    const messageElement = document.getElementById(`msg-${messageKey}`);

                    // URL Ï∂îÏ∂ú Î∞è ÎØ∏Î¶¨Î≥¥Í∏∞ Ï∂îÍ∞Ä
                    if (message.type === 'text' && messageElement) {
                        const url = extractUrl(message.text);
                        if (url) {
                            addLinkPreview(url, messageElement);
                        }
                    }
                    
                    if (!isFirstLoad && message.nickname !== myNickname) {
                        showBrowserNotification(message.nickname, message.text);
                    }
                });

                // 4. Î©îÏãúÏßÄ Î≥ÄÍ≤Ω Î¶¨Ïä§ÎÑà
                recentQuery.on('child_changed', (snapshot) => {
                    const message = snapshot.val();
                    if (!loadedMessageIds.has(snapshot.key)) return;
                    updateMessageInUI(message, snapshot.key);
                });

                // 5. Ï¥àÍ∏∞ Î°úÎî© ÌôïÏù∏
                recentQuery.once('value', () => {
                    // Ï¥àÍ∏∞ Î†åÎçî ÏßÅÌõÑ Îß® ÏïÑÎûò Í≥†Ï†ï ÌõÑÏóêÎßå ÏÉÅÎã® Ïä§ÌÅ¨Î°§ Î°úÎî©ÏùÑ ÌóàÏö©ÌïúÎã§.
                    requestAnimationFrame(() => {
                        const container = document.getElementById('messages');
                        container.scrollTop = container.scrollHeight;
                        requestAnimationFrame(() => {
                            container.scrollTop = container.scrollHeight;
                            isFirstLoad = false;
                            canLoadOlderOnScroll = true;
                        });
                    });
                });

                // 6. ÏïåÎ¶º ÏÑ§Ï†ï Î≥µÍµ¨
                const savedNotificationSetting = localStorage.getItem('chatNotificationEnabled');
                if (savedNotificationSetting === 'true') {
                    const granted = await requestNotificationPermission();
                    if (granted) {
                        notificationEnabled = true;
                        document.getElementById('notificationBtn').classList.add('active');
                    }
                }

            } catch (error) {
                document.getElementById('nicknameError').textContent = 'Firebase Ïó∞Í≤∞ Ïã§Ìå®: ' + error.message;
                console.error('Error:', error);
            }
        }

        async function loadPreviousDayMessages() {
            if (!messagesRef || isLoadingHistory || !hasMoreHistory || historyWindowStart === null) return;

            isLoadingHistory = true;
            const rangeEnd = historyWindowStart;
            const rangeStart = Math.max(0, rangeEnd - DAY_MS);

            try {
                const snapshot = await messagesRef
                    .orderByChild('timestamp')
                    .startAt(rangeStart)
                    .endAt(rangeEnd - 1)
                    .once('value');

                const batch = [];
                snapshot.forEach((child) => {
                    const messageId = child.key;
                    if (loadedMessageIds.has(messageId)) return;
                    loadedMessageIds.add(messageId);
                    batch.push({ id: messageId, message: child.val() });
                });

                batch.sort((a, b) => (a.message.timestamp || 0) - (b.message.timestamp || 0));
                const inserted = prependHistoricalMessages(batch);

                for (const item of inserted) {
                    const url = item.message.type === 'text' ? extractUrl(item.message.text || '') : null;
                    if (url) {
                        addLinkPreview(url, item.element);
                    }
                }

                historyWindowStart = rangeStart;
                if (historyWindowStart <= 0) {
                    hasMoreHistory = false;
                }
            } catch (error) {
                console.error('Ïù¥Ï†Ñ Î©îÏãúÏßÄ Î°úÎî© Ïã§Ìå®:', error);
            } finally {
                isLoadingHistory = false;
            }
        }

        // ÌÖçÏä§Ìä∏ÏóêÏÑú URLÎßå ÎΩëÏïÑÎÇ¥Îäî Ìï®Ïàò
        function extractUrl(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const match = text.match(urlRegex);
            return match ? match[0] : null;
        }

        async function addLinkPreview(url, messageRowElement) {
            try {
                const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const data = result.data;
                    const previewHtml = `
                        <a href="${url}" target="_blank" class="link-preview">
                            ${data.image ? `<img src="${data.image.url}" alt="preview">` : ''}
                            <div class="link-preview-info">
                                <div class="link-preview-title">${data.title || 'ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÜÏùå'}</div>
                                <div class="link-preview-desc">${data.description || ''}</div>
                            </div>
                        </a>
                    `;
                    
                    // Î©îÏãúÏßÄ Î≤ÑÎ∏î Î∞îÎ°ú ÏïÑÎûòÏóê ÏÇΩÏûÖ (ÎßêÌíçÏÑ† ÏöîÏÜåÏù∏ message-contentÎ•º Ï∞æÏïÑÏÑú Ï∂îÍ∞Ä)
                    const messagesContainer = document.getElementById('messages');
                    const atBottom = isNearBottom();
                    const contentArea = messageRowElement.querySelector('.message-content');
                    contentArea.insertAdjacentHTML('beforeend', previewHtml);

                    if (atBottom) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            } catch (e) {
                console.error("Preview error:", e);
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text === '' || !messagesRef) return;

            messagesRef.push({
                nickname: myNickname,
                text: text,
                timestamp: Date.now(),
                type: 'text',
                photoURL: myPhotoURL || null
            });

            input.value = '';
            input.style.height = 'auto';
            input.focus();
        }

        function createMessageElement(message, messageId, options = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.id = `msg-${messageId}`;
            const isMe = message.nickname === myNickname;
            messageDiv.className = `message ${isMe ? 'me' : 'other'}`;
            messageDiv.setAttribute('data-message-id', messageId);
            messageDiv.setAttribute('data-timestamp', String(message.timestamp || 0));
            
            if (!isFirstLoad && !options.silent) {
                messageDiv.classList.add('new');
            }
            
            const time = formatTime(message.timestamp);
            const initial = message.nickname.charAt(0).toUpperCase();
            const avatarContent = message.photoURL
                ? `<img src="${message.photoURL}" alt="${initial}">`
                : initial;
            
            let content = '';
            if (message.type === 'image-loading') {
                content = `<div class="image-loading"><div class="spinner"></div><div class="loading-text">ÏóÖÎ°úÎìú Ï§ë...</div></div>`;
            } else if (message.type === 'image' && message.imageUrl) {
                content = `<img src="${message.imageUrl}" onclick="openImageModal('${message.imageUrl}')" alt="image">`;
            } else {
                content = escapeHtml(message.text);
            }
            
            if (isMe) {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-row">
                            <div class="message-time">${time}</div>
                            <div class="message-bubble">${content}</div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatarContent}</div>
                    <div class="message-content">
                        <div class="message-nickname">${message.nickname}</div>
                        <div class="message-row">
                            <div class="message-bubble">${content}</div>
                            <div class="message-time">${time}</div>
                        </div>
                    </div>
                `;
            }

            return messageDiv;
        }

        function addMessageToUI(message, messageId) {
            const container = document.getElementById('messages');
            const messageDateKey = getDateKey(message.timestamp);
            const isMe = message.nickname === myNickname;
            const atBottom = isNearBottom();
            const messageDiv = createMessageElement(message, messageId);

            if (messageDateKey !== lastRenderedDateKey) {
                const dateDivider = document.createElement('div');
                dateDivider.className = 'date-divider';
                dateDivider.textContent = formatDateDivider(message.timestamp);
                container.appendChild(dateDivider);
                lastRenderedDateKey = messageDateKey;
            }

            container.appendChild(messageDiv);

            if (isFirstLoad || isMe || atBottom) {
                container.scrollTop = container.scrollHeight;
            } else if (!isFirstLoad && !isMe) {
                showNewMessageBanner();
            }

            if (!isFirstLoad && message.nickname !== myNickname) {
                notifyInTitle();
            }

        }

        function prependHistoricalMessages(messageEntries) {
            if (!messageEntries.length) return [];

            const container = document.getElementById('messages');
            const previousScrollHeight = container.scrollHeight;
            const previousScrollTop = container.scrollTop;
            const firstChild = container.firstElementChild;
            const firstMessage = container.querySelector('.message');
            const firstMessageTimestamp = firstMessage ? Number(firstMessage.getAttribute('data-timestamp')) : null;
            const topDateKey = firstMessageTimestamp ? getDateKey(firstMessageTimestamp) : null;

            const lastIncomingDateKey = getDateKey(messageEntries[messageEntries.length - 1].message.timestamp);
            const shareTopDate = Boolean(firstChild && firstChild.classList.contains('date-divider') && topDateKey === lastIncomingDateKey);
            const insertBeforeNode = shareTopDate ? firstChild.nextSibling : firstChild;

            const fragment = document.createDocumentFragment();
            let previousDateKey = null;
            const insertedMessageElements = [];

            for (const entry of messageEntries) {
                const message = entry.message;
                const messageDateKey = getDateKey(message.timestamp);
                const shouldDrawDivider = messageDateKey !== previousDateKey && !(shareTopDate && messageDateKey === topDateKey);

                if (shouldDrawDivider) {
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    dateDivider.textContent = formatDateDivider(message.timestamp);
                    fragment.appendChild(dateDivider);
                }

                const messageElement = createMessageElement(message, entry.id, { silent: true });
                fragment.appendChild(messageElement);
                insertedMessageElements.push({ message, element: messageElement });
                previousDateKey = messageDateKey;
            }

            container.insertBefore(fragment, insertBeforeNode || null);
            const newScrollHeight = container.scrollHeight;
            container.scrollTop = previousScrollTop + (newScrollHeight - previousScrollHeight);
            return insertedMessageElements;
        }

        function updateMessageInUI(message, messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;
            
            const isMe = message.nickname === myNickname;
            
            let content = '';
            if (message.type === 'image' && message.imageUrl) {
                content = `<img src="${message.imageUrl}" onclick="openImageModal('${message.imageUrl}')" alt="image">`;
            } else {
                content = escapeHtml(message.text);
            }
            
            const container = document.getElementById('messages');
            const atBottom = isNearBottom();

            const bubble = messageDiv.querySelector('.message-bubble');
            if (bubble) {
                bubble.innerHTML = content;
            }

            if (atBottom) {
                container.scrollTop = container.scrollHeight;
            }

        }

        function toggleSearchBar() {
            const toolbar = document.getElementById('searchToolbar');
            if (toolbar.classList.contains('show')) {
                closeSearchBar();
                return;
            }

            toolbar.classList.add('show');
            document.getElementById('searchBtn').classList.add('active');
            const input = document.getElementById('searchInput');
            input.focus();
            input.select();
            resetSearchResults();
        }

        function closeSearchBar() {
            document.getElementById('searchToolbar').classList.remove('show');
            document.getElementById('searchBtn').classList.remove('active');
            document.getElementById('searchInput').value = '';
            resetSearchResults();
        }

        function onSearchInputChanged() {
            resetSearchResults();
        }

        function executeSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            searchMatches = [];
            currentSearchMatchIndex = -1;
            clearSearchSelection();

            if (!query) {
                updateSearchNavButtons();
                return;
            }

            const messageEls = document.querySelectorAll('#messages .message');
            messageEls.forEach((messageEl) => {
                const bubble = messageEl.querySelector('.message-bubble');
                if (!bubble) return;
                const text = (bubble.textContent || '').toLowerCase();
                if (text.includes(query)) {
                    searchMatches.push(messageEl);
                }
            });

            if (searchMatches.length === 0) {
                showToast('Ìï¥Îãπ ÎÇ¥Ïö©Ïù¥ Ìè¨Ìï®Îêú Î©îÏãúÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§', 1000);
                updateSearchNavButtons();
                return;
            }

            currentSearchMatchIndex = 0;
            focusSearchResult(currentSearchMatchIndex);
            updateSearchNavButtons();
        }

        function handleSearchKeyDown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                moveSearchResult(event.shiftKey ? -1 : 1);
            } else if (event.key === 'Escape') {
                closeSearchBar();
            }
        }

        function moveSearchResult(direction) {
            if (!searchMatches.length) return;
            currentSearchMatchIndex = (currentSearchMatchIndex + direction + searchMatches.length) % searchMatches.length;
            focusSearchResult(currentSearchMatchIndex);
            updateSearchCount();
        }

        function focusSearchResult(index) {
            clearSearchSelection();
            const target = searchMatches[index];
            if (!target) return;
            target.classList.add('search-selected');
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateSearchCount();
        }

        function clearSearchSelection() {
            const selected = document.querySelector('#messages .message.search-selected');
            if (selected) {
                selected.classList.remove('search-selected');
            }
        }

        function updateSearchNavButtons() {
            const disabled = searchMatches.length === 0;
            document.getElementById('searchPrevBtn').disabled = disabled;
            document.getElementById('searchNextBtn').disabled = disabled;
            updateSearchCount();
        }

        function updateSearchCount() {
            const countEl = document.getElementById('searchCount');
            if (!countEl) return;
            if (!searchMatches.length || currentSearchMatchIndex < 0) {
                countEl.textContent = '0/0';
                return;
            }
            countEl.textContent = `${currentSearchMatchIndex + 1}/${searchMatches.length}`;
        }

        function resetSearchResults() {
            searchMatches = [];
            currentSearchMatchIndex = -1;
            clearSearchSelection();
            updateSearchNavButtons();
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'Ïò§ÌõÑ' : 'Ïò§Ï†Ñ';
            const displayHours = hours % 12 || 12;
            return `${ampm} ${displayHours}:${minutes}`;
        }

        function getDateKey(timestamp) {
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        }

        function formatDateDivider(timestamp) {
            const d = new Date(timestamp);
            const weekday = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'][d.getDay()];
            return `${d.getFullYear()}ÎÖÑ ${d.getMonth() + 1}Ïõî ${d.getDate()}Ïùº (${weekday})`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function reachedTopDateDivider(container) {
            if (!container) return false;
            if (container.scrollTop <= 20) return true;

            const firstDivider = container.querySelector('.date-divider');
            if (!firstDivider) return false;
            return container.scrollTop <= firstDivider.offsetTop + 2;
        }

        // Ïä§ÌÅ¨Î°§Ïù¥ ÌïòÎã®Ïóê ÎèÑÎã¨ÌïòÎ©¥ Î∞∞ÎÑà Ïà®ÍπÄ
        document.getElementById('messages').addEventListener('scroll', function() {
            if (isNearBottom()) {
                hideNewMessageBanner();
            }

            if (canLoadOlderOnScroll && reachedTopDateDivider(this)) {
                loadPreviousDayMessages();
            }
        });

        let originalTitle = document.title;
        let newMessageCount = 0;
        let titleInterval;

        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                document.title = originalTitle;
                newMessageCount = 0;
                if (titleInterval) {
                    clearInterval(titleInterval);
                    titleInterval = null;
                }
            }
        });

        function notifyInTitle() {
            if (!document.hidden) return;
            
            newMessageCount++;
            
            if (!titleInterval) {
                let toggle = false;
                titleInterval = setInterval(() => {
                    document.title = toggle ? originalTitle : `(${newMessageCount}) üí¨ ÏÉà Î©îÏãúÏßÄ`;
                    toggle = !toggle;
                }, 1000);
            }
        }
    </script>
</body>
</html>
