<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
        }
        .nickname-container {
            width: 100%;
            max-width: 400px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 40px 30px;
            text-align: center;
            margin: 20px;
        }
        .nickname-container h2 {
            margin-bottom: 30px;
            color: #000;
            font-size: 20px;
            font-weight: 600;
        }
        .nickname-container input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        .nickname-container input:focus {
            outline: none;
            border-color: #a8d4f5;
        }
        .nickname-container button {
            width: 100%;
            padding: 14px 24px;
            background: #a8d4f5;
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            transition: background 0.2s;
        }
        .nickname-container button:hover {
            background: #91c7f0;
        }
        .chat-container {
            width: 100%;
            max-width: 100vw;
            height: 100vh;
            background: #ffffff;
            display: none;
            flex-direction: column;
        }
        .chat-container.active {
            display: flex;
        }
        .chat-header {
            background: #fff;
            padding: 12px 16px;
            border-bottom: 1px solid #d1d1d1;
            font-weight: 600;
            font-size: 18px;
            color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 56px;
        }
        .chat-header-title {
            flex: 1;
        }
        .notification-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s;
        }
        .notification-btn:hover {
            background: #f5f5f5;
        }
        .notification-btn.active {
            color: #a8d4f5;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }
        .drop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(168, 212, 245, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            color: #000;
            z-index: 10;
            pointer-events: none;
        }
        .drop-overlay.show {
            display: flex;
        }
        .message {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            align-items: flex-end;
        }
        .message.me {
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
            border: 1px solid #e0e0e0;
        }
        .message.me .message-avatar {
            display: none;
        }
        .message-content {
            display: flex;
            flex-direction: column;
            max-width: 65%;
            gap: 4px;
        }
        .message.me .message-content {
            align-items: flex-end;
        }
        .message-nickname {
            font-size: 12px;
            font-weight: 500;
            color: #000;
            padding: 0 4px;
            margin-bottom: 2px;
        }
        .message.me .message-nickname {
            display: none;
        }
        .message-row {
            display: flex;
            align-items: flex-end;
            gap: 4px;
        }
        .message.me .message-row {
            flex-direction: row-reverse;
        }
        .message-bubble {
            padding: 8px 12px;
            border-radius: 4px;
            word-wrap: break-word;
            background: #F1F3F4;
            color: #000;
            font-size: 14px;
            line-height: 20px;
            max-width: 100%;
            white-space: pre-wrap;
        }
        .message.me .message-bubble {
            background: #D2E3FC;
            color: #000;
        }
        .message-bubble img {
            max-width: 250px;
            max-height: 250px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
        }
        .image-loading {
            width: 250px;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 8px;
            gap: 12px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #a8d4f5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 13px;
            color: #666;
        }
        .message-time {
            font-size: 11px;
            color: rgba(0, 0, 0, 0.4);
            white-space: nowrap;
            align-self: flex-end;
            padding: 0 2px;
        }
        .message.new {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chat-input-container {
            padding: 8px 12px;
            background: #fff;
            border-top: 1px solid #d1d1d1;
        }
        .chat-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid #d1d1d1;
            border-radius: 20px;
            background: #F1F3F4;
            transition: border-color 0.2s;
        }
        .chat-input:focus-within {
            border-color: #999;
            background: #F1F3F4;
        }
        .chat-input textarea {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
            color: #000;
            background: transparent;
            resize: none;
            max-height: 120px;
            min-height: 20px;
            font-family: inherit;
            line-height: 20px;
            overflow-y: auto;
        }
        .input-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .plus-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            color: #666;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 24px;
            font-weight: 300;
            position: relative;
        }
        .plus-btn:hover {
            background: rgba(0,0,0,0.05);
        }
        .plus-menu {
            position: absolute;
            bottom: 45px;
            left: 0;
            background: white;
            border: 1px solid #d1d1d1;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
            min-width: 140px;
            z-index: 100;
        }
        .plus-menu.show {
            display: block;
        }
        .plus-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #000;
            transition: background 0.2s;
        }
        .plus-menu-item:hover {
            background: #f5f5f5;
        }
        .plus-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        .plus-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        .send-btn {
            width: 32px;
            height: 32px;
            background: #a8d4f5;
            color: #000;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 16px;
            font-weight: bold;
        }
        .send-btn:hover {
            background: #91c7f0;
        }
        .send-btn:disabled {
            background: #d1d1d1;
            cursor: not-allowed;
        }
        .error {
            color: #e03131;
            font-size: 13px;
            margin-top: 12px;
        }
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: toastSlideIn 0.3s ease-out;
            font-size: 14px;
        }
        .notification-toast.show {
            display: flex;
        }
        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        .image-modal.show {
            display: flex;
        }
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        #fileInput {
            display: none;
        }

        /* URL ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .link-preview {
            margin-top: 8px;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            border: 1px solid #ddd;
            width: 100%;
            max-width: 250px;
            cursor: pointer;
            text-decoration: none;
            display: block;
        }
        .link-preview img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .link-preview-info {
            padding: 8px;
        }
        .link-preview-title {
            font-size: 13px;
            font-weight: bold;
            color: #000;
            margin-bottom: 4px;
            display: -webkit-box;

            line-clamp: 1;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .link-preview-desc {
            font-size: 11px;
            color: #666;
            display: -webkit-box;

            line-clamp: 1;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="nickname-container" id="nicknameContainer">
        <h2>ğŸ’¬ ì±„íŒ…ë°© ì…ì¥</h2>
        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10" onkeypress="if(event.key==='Enter') enterChat()">
        <button onclick="enterChat()">ì…ì¥í•˜ê¸°</button>
        <div class="error" id="nicknameError"></div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-header-title" id="chatHeader">ì±„íŒ…</div>
            <button class="notification-btn" id="notificationBtn" onclick="toggleNotification()" title="ì•Œë¦¼ ì„¤ì •">
                ğŸ””
            </button>
        </div>
        <div class="chat-messages" id="messages">
            <div class="drop-overlay" id="dropOverlay">ğŸ“· ì‚¬ì§„ì„ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”</div>
        </div>
        <div class="chat-input-container">
            <div class="chat-input">
                <div style="position: relative;">
                    <button class="plus-btn" id="plusBtn" onclick="togglePlusMenu()">+</button>
                    <div class="plus-menu" id="plusMenu">
                        <div class="plus-menu-item" onclick="openImagePicker()">
                            ğŸ“· ì‚¬ì§„ ì¶”ê°€
                        </div>
                    </div>
                </div>
                <textarea id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
                <div class="input-buttons">
                    <button class="send-btn" onclick="sendMessage()">â†‘</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" onchange="handleImageSelect(event)">

    <div class="notification-toast" id="notificationToast">
        <span id="toastMessage"></span>
    </div>

    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="">
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <script>
        let myNickname = '';
        let database;
        let storage;
        let messagesRef;
        let notificationEnabled = false;
        let isFirstLoad = true;

        // textarea ìë™ ë†’ì´ ì¡°ì ˆ
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Enter í‚¤ ì²˜ë¦¬ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ, EnterëŠ” ì „ì†¡)
        function handleKeyDown(event) {
            // í•œê¸€ ì¡°í•© ì¤‘ì—ëŠ” ë¬´ì‹œ (Mac í•œê¸€ ì…ë ¥ ë²„ê·¸ ë°©ì§€)
            if (event.isComposing || event.keyCode === 229) {
                return;
            }
            
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // + ë©”ë‰´ í† ê¸€
        function togglePlusMenu() {
            const menu = document.getElementById('plusMenu');
            menu.classList.toggle('show');
        }

        // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const plusBtn = document.getElementById('plusBtn');
            const plusMenu = document.getElementById('plusMenu');
            if (plusBtn && plusMenu && !plusBtn.contains(event.target) && !plusMenu.contains(event.target)) {
                plusMenu.classList.remove('show');
            }
        });

        // ì´ë¯¸ì§€ ì„ íƒì°½ ì—´ê¸°
        function openImagePicker() {
            document.getElementById('fileInput').click();
            document.getElementById('plusMenu').classList.remove('show');
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬ (íŒŒì¼ ì„ íƒ/ë¶™ì—¬ë„£ê¸°/ë“œë˜ê·¸ì•¤ë“œë ê³µí†µ)
        async function uploadImage(file) {
            if (!file) return;

            // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('ì´ë¯¸ì§€ëŠ” 5MB ì´í•˜ë§Œ ì „ì†¡ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }

            // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
            if (!file.type.startsWith('image/')) {
                showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì „ì†¡ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }

            try {
                const timestamp = Date.now();
                
                // ë¡œë”© ë©”ì‹œì§€ ë¨¼ì € í‘œì‹œ
                const loadingMessageRef = await messagesRef.push({
                    nickname: myNickname,
                    timestamp: timestamp,
                    type: 'image-loading'
                });
                
                // Firebase Storageì— ì—…ë¡œë“œ
                const filename = `${timestamp}_${file.name}`;
                const storageRef = storage.ref(`images/${filename}`);
                
                const snapshot = await storageRef.put(file);
                const imageUrl = await snapshot.ref.getDownloadURL();

                // ë¡œë”© ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸
                await loadingMessageRef.update({
                    imageUrl: imageUrl,
                    type: 'image'
                });
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬
        async function handleImageSelect(event) {
            const file = event.target.files[0];
            await uploadImage(file);
            event.target.value = '';
        }

        // ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener('paste', async function(event) {
            if (!messagesRef) return;
            
            const items = event.clipboardData?.items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault();
                    const file = items[i].getAsFile();
                    await uploadImage(file);
                    break;
                }
            }
        });

        // ë“œë˜ê·¸ì•¤ë“œë ì´ë²¤íŠ¸ ì²˜ë¦¬
        let dragCounter = 0;
        const messagesContainer = document.getElementById('messages');
        const dropOverlay = document.getElementById('dropOverlay');

        document.addEventListener('dragenter', function(event) {
            if (!messagesRef) return;
            dragCounter++;
            if (event.dataTransfer.types.includes('Files')) {
                dropOverlay.classList.add('show');
            }
        });

        document.addEventListener('dragleave', function(event) {
            if (!messagesRef) return;
            dragCounter--;
            if (dragCounter === 0) {
                dropOverlay.classList.remove('show');
            }
        });

        document.addEventListener('dragover', function(event) {
            if (!messagesRef) return;
            if (event.dataTransfer.types.includes('Files')) {
                event.preventDefault();
            }
        });

        document.addEventListener('drop', async function(event) {
            if (!messagesRef) return;
            event.preventDefault();
            dragCounter = 0;
            dropOverlay.classList.remove('show');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                await uploadImage(files[0]);
            }
        });

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
        function openImageModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('show');
            modalImg.src = imageUrl;
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
        }

        // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }

            return false;
        }

        // ì•Œë¦¼ í† ê¸€
        async function toggleNotification() {
            const btn = document.getElementById('notificationBtn');
            
            if (!notificationEnabled) {
                const granted = await requestNotificationPermission();
                if (granted) {
                    notificationEnabled = true;
                    btn.classList.add('active');
                    showToast('ì•Œë¦¼ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤');
                    localStorage.setItem('chatNotificationEnabled', 'true');
                } else {
                    showToast('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            } else {
                notificationEnabled = false;
                btn.classList.remove('active');
                showToast('ì•Œë¦¼ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤');
                localStorage.setItem('chatNotificationEnabled', 'false');
            }
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
        function showToast(message) {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ
        function showBrowserNotification(nickname, text) {
            if (!notificationEnabled || !('Notification' in window)) return;
            if (Notification.permission !== 'granted') return;
            
            if (document.hasFocus()) return;

            const notification = new Notification(`ğŸ’¬ ${nickname}ë‹˜ì˜ ë©”ì‹œì§€`, {
                body: text || 'ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤',
                tag: 'chat-message',
                requireInteraction: false
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };

            setTimeout(() => notification.close(), 3000);
        }

        async function enterChat() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            
            // 1. ë‹‰ë„¤ì„ ìœ íš¨ì„± ê²€ì‚¬
            if (nickname === '') {
                document.getElementById('nicknameError').textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            if (nickname.length < 2) {
                document.getElementById('nicknameError').textContent = 'ë‹‰ë„¤ì„ì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            myNickname = nickname;

            try {
                if (typeof firebase === 'undefined') {
                    document.getElementById('nicknameError').textContent = 'Firebase ë¡œë”© ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    return;
                }

                document.getElementById('nicknameError').textContent = 'Firebase ì—°ê²° ì¤‘...';
                
                // 2. Firebase ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
                if (firebase.apps.length === 0) {
                    const response = await fetch('/.netlify/functions/firebase-config');
                    if (!response.ok) {
                        throw new Error('Firebase ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    const firebaseConfig = await response.json();
                    firebase.initializeApp(firebaseConfig);
                }

                database = firebase.database();
                storage = firebase.storage();
                messagesRef = database.ref('messages');

                // 3. ë©”ì‹œì§€ ì¶”ê°€ ë¦¬ìŠ¤ë„ˆ (ë¯¸ë¦¬ë³´ê¸° ë¡œì§ í†µí•©)
                messagesRef.on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    const messageKey = snapshot.key;
                    
                    // UIì— ë©”ì‹œì§€ ì¶”ê°€ (ì´ í•¨ìˆ˜ê°€ ìš”ì†Œë¥¼ ìƒì„±í•¨)
                    addMessageToUI(message, messageKey);
                    
                    // ì¶”ê°€ëœ ë©”ì‹œì§€ ìš”ì†Œ ì°¾ê¸°
                    const messageElement = document.getElementById(`msg-${messageKey}`);

                    // URL ì¶”ì¶œ ë° ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
                    if (message.type === 'text' && messageElement) {
                        const url = extractUrl(message.text);
                        if (url) {
                            addLinkPreview(url, messageElement);
                        }
                    }
                    
                    if (!isFirstLoad && message.nickname !== myNickname) {
                        showBrowserNotification(message.nickname, message.text);
                    }
                });

                // 4. ë©”ì‹œì§€ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
                messagesRef.on('child_changed', (snapshot) => {
                    const message = snapshot.val();
                    updateMessageInUI(message, snapshot.key);
                });

                // 5. ì´ˆê¸° ë¡œë”© í™•ì¸
                messagesRef.once('value', () => {
                    setTimeout(() => {
                        isFirstLoad = false;
                    }, 1000);
                });

                // 6. ì•Œë¦¼ ì„¤ì • ë³µêµ¬
                const savedNotificationSetting = localStorage.getItem('chatNotificationEnabled');
                if (savedNotificationSetting === 'true') {
                    const granted = await requestNotificationPermission();
                    if (granted) {
                        notificationEnabled = true;
                        document.getElementById('notificationBtn').classList.add('active');
                    }
                }

                // 7. UI ì „í™˜
                document.getElementById('nicknameContainer').style.display = 'none';
                document.getElementById('chatContainer').classList.add('active');
                document.getElementById('chatHeader').textContent = myNickname;
                document.getElementById('messageInput').focus();

            } catch (error) {
                document.getElementById('nicknameError').textContent = 'Firebase ì—°ê²° ì‹¤íŒ¨: ' + error.message;
                console.error('Error:', error);
            }
        }

        // í…ìŠ¤íŠ¸ì—ì„œ URLë§Œ ë½‘ì•„ë‚´ëŠ” í•¨ìˆ˜
        function extractUrl(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const match = text.match(urlRegex);
            return match ? match[0] : null;
        }

        async function addLinkPreview(url, messageRowElement) {
            try {
                const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const data = result.data;
                    const previewHtml = `
                        <a href="${url}" target="_blank" class="link-preview">
                            ${data.image ? `<img src="${data.image.url}" alt="preview">` : ''}
                            <div class="link-preview-info">
                                <div class="link-preview-title">${data.title || 'ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ'}</div>
                                <div class="link-preview-desc">${data.description || ''}</div>
                            </div>
                        </a>
                    `;
                    
                    // ë©”ì‹œì§€ ë²„ë¸” ë°”ë¡œ ì•„ë˜ì— ì‚½ì… (ë§í’ì„  ìš”ì†Œì¸ message-contentë¥¼ ì°¾ì•„ì„œ ì¶”ê°€)
                    const contentArea = messageRowElement.querySelector('.message-content');
                    contentArea.insertAdjacentHTML('beforeend', previewHtml);
                    
                    // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ ë‚´ë¦¬ê¸°
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } catch (e) {
                console.error("Preview error:", e);
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text === '' || !messagesRef) return;

            messagesRef.push({
                nickname: myNickname,
                text: text,
                timestamp: Date.now(),
                type: 'text'
            });

            input.value = '';
            input.style.height = 'auto';
            input.focus();
        }

        function addMessageToUI(message, messageId) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.id = `msg-${messageId}`;

            const isMe = message.nickname === myNickname;
            messageDiv.className = `message ${isMe ? 'me' : 'other'}`;
            messageDiv.setAttribute('data-message-id', messageId);
            
            if (!isFirstLoad) {
                messageDiv.classList.add('new');
            }
            
            const time = formatTime(message.timestamp);
            const initial = message.nickname.charAt(0).toUpperCase();
            
            let content = '';
            if (message.type === 'image-loading') {
                content = `<div class="image-loading"><div class="spinner"></div><div class="loading-text">ì—…ë¡œë“œ ì¤‘...</div></div>`;
            } else if (message.type === 'image' && message.imageUrl) {
                content = `<img src="${message.imageUrl}" onclick="openImageModal('${message.imageUrl}')" alt="image">`;
            } else {
                content = escapeHtml(message.text);
            }
            
            if (isMe) {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-row">
                            <div class="message-time">${time}</div>
                            <div class="message-bubble">${content}</div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">${initial}</div>
                    <div class="message-content">
                        <div class="message-nickname">${message.nickname}</div>
                        <div class="message-row">
                            <div class="message-bubble">${content}</div>
                            <div class="message-time">${time}</div>
                        </div>
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            if (!isFirstLoad && message.nickname !== myNickname) {
                notifyInTitle();
            }
        }

        function updateMessageInUI(message, messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;
            
            const isMe = message.nickname === myNickname;
            
            let content = '';
            if (message.type === 'image' && message.imageUrl) {
                content = `<img src="${message.imageUrl}" onclick="openImageModal('${message.imageUrl}')" alt="image">`;
            } else {
                content = escapeHtml(message.text);
            }
            
            const bubble = messageDiv.querySelector('.message-bubble');
            if (bubble) {
                bubble.innerHTML = content;
            }
            
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            const displayHours = hours % 12 || 12;
            return `${ampm} ${displayHours}:${minutes}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let originalTitle = document.title;
        let newMessageCount = 0;
        let titleInterval;

        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                document.title = originalTitle;
                newMessageCount = 0;
                if (titleInterval) {
                    clearInterval(titleInterval);
                    titleInterval = null;
                }
            }
        });

        function notifyInTitle() {
            if (!document.hidden) return;
            
            newMessageCount++;
            
            if (!titleInterval) {
                let toggle = false;
                titleInterval = setInterval(() => {
                    document.title = toggle ? originalTitle : `(${newMessageCount}) ğŸ’¬ ìƒˆ ë©”ì‹œì§€`;
                    toggle = !toggle;
                }, 1000);
            }
        }
    </script>
</body>
</html>